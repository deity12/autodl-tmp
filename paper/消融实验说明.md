# 消融实验脚本使用说明

## 📋 实验设计

根据论文 3.2 节，本脚本将运行 **5 组实验**（1个完整模型基准 + 4组消融实验），所有实验在完全相同的条件下运行，确保公平对比：

### 实验列表

**实验 0：Full Model（基准）** - 所有模块开启，作为性能上限
- ✅ Quantum（量子模块）
- ✅ Graph（图神经网络）
- ✅ MATCC（趋势解耦）
- ✅ Market Guidance（市场引导）

**实验 1：w/o Quantum** (`no_quantum`) - 移除 VQC，仅使用经典 MLP
- ❌ Quantum
- ✅ Graph
- ✅ MATCC
- ✅ Market Guidance

**实验 2：w/o Graph** (`no_graph`) - 移除 GAT 层（使用单位阵）
- ✅ Quantum
- ❌ Graph
- ✅ MATCC
- ✅ Market Guidance

**实验 3：w/o MATCC** (`no_matcc`) - 移除趋势解耦模块
- ✅ Quantum
- ✅ Graph
- ❌ MATCC
- ✅ Market Guidance

**实验 4：w/o Market Guidance** (`no_market_guidance`) - 移除大盘指数输入
- ✅ Quantum
- ✅ Graph
- ✅ MATCC
- ❌ Market Guidance

**重要**：Full Model 会在脚本中自动运行，作为对比基准。这样可以确保所有实验在完全相同的实验条件下（相同的 epochs、batch_size、随机种子等）进行公平对比。

## 🚀 运行方法

```bash
cd paper/model
python run_ablation.py
```

## ✅ 相比 Gemini3pro 建议的改进点

### 1. **完整性** ✅
- ✅ 添加了 **Full Model 基准实验**：确保所有实验在相同条件下公平对比
- ✅ 添加了 **w/o Market Guidance** 实验（论文中第4组消融实验）
- ✅ 完整覆盖了论文中提到的所有消融变体（5组实验：1个基准 + 4个消融）

### 2. **结果保存** ✅
- ✅ 保存每个实验的**最佳模型** (`best_model_{exp_name}.pth`)，便于后续深入分析
- ✅ 生成**汇总CSV表格** (`ablation_results_summary.csv`)，包含：
  - **统计误差类**：MSE, MAE, RMSE, R², MAPE
  - **方向预测类**：Directional Accuracy（方向准确率）
  - **量化投资类**：IC (Information Coefficient), RankIC (Rank Information Coefficient) ⭐
  - 最佳验证损失、最佳epoch、最终训练/验证损失
  - 各模块开关状态
- ✅ **所有评估指标自动计算并保存**，包括量化金融领域的黄金标准指标（IC、RankIC）

### 3. **可视化增强** ✅
- ✅ 生成**对比图表** (`ablation_results_comparison.png`)，包含：
  - 左图：柱状图 - 各实验最佳验证损失对比（Full Model 用金色突出显示）
  - 右图：横向柱状图 - 按损失值排序，直观展示性能排名
- ✅ Full Model 在图表中用**金色（#FFD700）**标记，便于识别基准线

### 4. **代码健壮性** ✅
- ✅ **路径自动检测**：支持多种可能的数据路径
- ✅ **错误处理**：文件不存在时的友好提示
- ✅ **显存管理**：每轮实验后清理显存
- ✅ **学习率调度**：与原训练脚本保持一致

### 5. **实验记录** ✅
- ✅ 记录详细的实验配置和结果
- ✅ 自动计算总耗时
- ✅ 生成实验汇总报告

## 📊 输出文件说明

运行完成后，所有消融实验结果都会保存在 `paper/model/ablation/` 目录下，避免与原有文件混淆：

```
paper/model/
└── ablation/                              # 消融实验专用目录
    ├── curve_full_model.png                  # 实验0：完整模型基准的训练曲线
    ├── curve_no_quantum.png                  # 实验1：无量子模块的训练曲线
    ├── curve_no_graph.png                    # 实验2：无图神经网络的训练曲线
    ├── curve_no_matcc.png                    # 实验3：无趋势解耦的训练曲线
    ├── curve_no_market_guidance.png          # 实验4：无市场引导的训练曲线
    ├── best_model_full_model.pth             # 实验0：完整模型基准的最佳模型
    ├── best_model_no_quantum.pth             # 实验1：无量子模块的最佳模型
    ├── best_model_no_graph.pth               # 实验2：无图神经网络的最佳模型
    ├── best_model_no_matcc.pth               # 实验3：无趋势解耦的最佳模型
    ├── best_model_no_market_guidance.pth     # 实验4：无市场引导的最佳模型
    ├── losses_full_model.json                # 实验0：完整模型的 Loss 数值列表
    ├── losses_no_quantum.json                # 实验1：无量子模块的 Loss 数值列表
    ├── losses_no_graph.json                  # 实验2：无图神经网络的 Loss 数值列表
    ├── losses_no_matcc.json                  # 实验3：无趋势解耦的 Loss 数值列表
    ├── losses_no_market_guidance.json        # 实验4：无市场引导的 Loss 数值列表
    ├── ablation_results_summary.csv          # 汇总结果表格（5行数据）
    └── ablation_results_comparison.png       # 对比图表（5条柱状图，Full Model用金色）
```

**优势**：
- ✅ 所有消融实验相关文件集中管理，不会与 `best_model_gnn.pth`、`training_curve_gnn.png` 等原有文件混淆
- ✅ Full Model 基准实验也保存在此目录，便于统一对比分析
- ✅ **所有 Loss 数值列表已保存为 JSON**，无需重新运行实验即可做对比分析
- ✅ 所有文件命名清晰，一目了然

## 📈 结果分析建议

### 1. 数值对比
查看 `ablation/ablation_results_summary.csv`，重点关注：

**核心指标（必须关注）**：
- **MSE**：训练主指标，数值越小越好
- **R²**：模型拟合优度，越接近1越好
- **Directional Accuracy**：方向准确率，金融预测核心指标（>50%表示有效）
- **IC (Information Coefficient)**：量化金融黄金标准，衡量预测线性相关性（>0.05表示不错）
- **RankIC (Rank Information Coefficient)**：基金公司最看重，衡量排序能力（>0.05表示不错）

**补充指标**：
- **MAE / RMSE**：更直观的误差度量
- **最佳epoch**：收敛速度对比
- **最终损失**：模型稳定性

### 2. 图表分析
- **训练曲线** (`ablation/curve_*.png`)：观察过拟合情况和收敛速度
- **对比图表** (`ablation/ablation_results_comparison.png`)：直观对比各模块贡献

### 3. 重新生成对比图表（无需重新运行实验）⭐
如果实验已完成，但想要重新生成对比图表，可以使用工具脚本：

```bash
cd paper/model
python plot_ablation_comparison.py
```

这个脚本会：
- ✅ 自动读取所有 `losses_*.json` 文件
- ✅ 生成训练曲线叠加对比图（所有实验的曲线在同一张图上）
- ✅ 生成柱状图对比（最佳验证损失）
- ✅ 生成汇总表格（包含所有评估指标：MSE, R², IC, RankIC, Directional Accuracy 等）
- ✅ 自动计算各模块的贡献（相比 Full Model 的性能下降百分比）
- ✅ **多指标对比分析**：展示 IC、RankIC、方向准确率等关键指标的变化

**优势**：无需重新运行实验，直接读取已保存的数值数据即可生成论文用的对比图表！

### 3. 论文撰写要点

在论文的"实验结果"部分，你可以这样组织：

```markdown
### 3.2 消融实验结果

表X展示了各模块的消融实验结果。我们首先在相同实验条件下运行完整模型（Full Model）作为基准，然后依次移除各模块进行对比。评估指标包括统计误差类（MSE, R²）、方向预测类（Directional Accuracy）以及量化投资类（IC, RankIC）。主要发现如下：

1. **完整模型的性能**：Full Model 在所有模块协同作用下，MSE 为 X.XXXXXX，R² 为 X.XXXX，方向准确率为 XX.X%，IC 为 X.XXXX，RankIC 为 X.XXXX，为后续消融实验提供了性能上限基准。

2. **量子模块的贡献**：w/o Quantum 相比 Full Model，MSE 上升了 X%，IC 下降了 X.XXXX，RankIC 下降了 X.XXXX，方向准确率下降了 X.X%，说明量子通道在处理高波动特征时具有不可替代的优势。

3. **图谱的作用**：w/o Graph 相比 Full Model，IC 下降了 X.XXXX，RankIC 下降了 X.XXXX，验证了LLM构建的关系图谱能提供额外增益，特别是在选股排序能力（RankIC）方面。

4. **趋势解耦的重要性**：w/o MATCC 相比 Full Model，R² 下降了 X.XXXX，说明趋势/波动解耦机制对非平稳数据的适应性至关重要。

5. **宏观引导的价值**：w/o Market Guidance 相比 Full Model，方向准确率下降了 X.X%，证明大盘指数信息对个股预测有显著辅助作用。

从对比图表（ablation_results_comparison.png）可以直观看出，Full Model 的性能显著优于所有消融变体，验证了各模块的有效性和协同作用。特别值得注意的是，IC 和 RankIC 作为量化金融领域的黄金标准指标，Full Model 在这两个指标上的优势进一步证明了模型在量化投资中的实用性。
```

**关键点**：
- ✅ 强调 IC 和 RankIC 是量化金融领域的黄金标准指标
- ✅ 展示各模块对 IC、RankIC、方向准确率等关键指标的影响
- ✅ 说明这些指标直接回答了"模型能否用于量化投资"的问题

## ⚠️ 注意事项

1. **显存占用**：5组实验会依次运行（1个基准 + 4个消融），每个实验需要一定显存。如果显存不足，可以适当减小 `batch_size` 或 `gnn_embd`。

2. **训练时间**：5组实验，每组最多 6 个 epoch（带早停机制），预计总耗时约 **50-80 分钟**（取决于你的硬件和数据集大小）。如果模型在第 3-4 个 epoch 就收敛，会自动早停。

3. **图谱文件**：如果 `Graph_Adjacency.npy` 不存在，脚本会自动使用单位阵（等价于无图实验），但仍需确保 `Final_Model_Data.csv` 存在。

4. **公平对比**：脚本会自动运行 Full Model 基准实验，确保所有实验在完全相同的条件下进行（相同的 epochs、batch_size、随机种子等）。所有结果都保存在 `ablation/` 目录下，便于统一分析和对比。

5. **文件组织**：所有消融实验相关文件（包括 Full Model 基准）都在 `ablation/` 目录下，不会与原有的 `best_model_gnn.pth`、`training_curve_gnn.png` 等文件混淆。

## 🔧 自定义配置

如果需要修改超参数（如减少epoch数以节省时间），可以直接编辑 `run_ablation.py` 中的 `BASE_CONFIG` 字典：

```python
BASE_CONFIG = {
    'epochs': 6,        # 当前设置为6，如果模型收敛快可以减小
    'batch_size': 3072, # 当前设置为3072，如果显存不足可以减小
    'early_stop_patience': 3,  # 早停耐心值，连续3个epoch无改善则停止
    # ... 其他参数
}
```

**建议**：由于消融实验主要是为了对比各模块的贡献，如果验证集上的损失在第 3-4 个 epoch 就稳定了，6 个 epoch 完全足够。早停机制会自动在模型不再改善时停止训练，节省时间。

## 💡 后续工作建议

1. **结果对比分析**：
   - 查看 `ablation_results_summary.csv`，计算各消融实验相比 Full Model 的性能下降百分比
   - **使用 `plot_ablation_comparison.py` 工具**自动计算并显示各模块的贡献
   - 分析哪个模块的移除对性能影响最大，验证论文的核心创新点

2. **Loss 数据保存** ⭐：
   - 所有实验的 Loss 数值列表已自动保存为 JSON 格式（`losses_*.json`）
   - 这些数据包含完整的训练/验证损失历史，可以用于：
     - 重新生成对比图表（无需重新运行实验）
     - 进行更深入的统计分析
     - 与其他实验结果进行对比
   - 建议保留这些 JSON 文件，方便后续分析

3. **高波动率区间分析**：根据论文要求，可以进一步分析各模型在**高波动率区间**的表现差异，验证量子模块在极端市场环境下的优势。

4. **可视化增强**：
   - 可以使用生成的 `ablation_results_comparison.png` 直接插入论文
   - 如果需要在论文中展示完整的训练曲线，可以手动将 5 条 `curve_*.png` 叠加在一起
   - 考虑生成模块贡献雷达图，更直观地展示各模块的相对重要性

5. **统计显著性检验**：如果条件允许，可以多次运行消融实验（建议至少 3 次），计算均值和标准差，进行统计显著性检验，使实验结果更具说服力。

6. **论文图表使用**：
   - `ablation_results_comparison.png` 可以直接用于论文的结果展示
   - `ablation_results_summary.csv` 中的数据可以整理成表格插入论文（**推荐格式见下方**）
   - 各实验的训练曲线（`curve_*.png`）可以作为补充材料

### 4. 论文表格推荐格式

在论文的结果部分，推荐使用以下表格格式（突出量化投资指标）：

| Model | MSE | R² | Dir. Acc. | IC | RankIC | MAE | RMSE |
|-------|-----|----|----|----|----|-----|------|
| Full Model | 0.001234 | 0.8234 | 68.5% | 0.1234 | 0.1156 | 0.023456 | 0.035123 |
| w/o Quantum | 0.001456 | 0.7890 | 65.2% | 0.0987 | 0.0923 | 0.024567 | 0.038123 |
| w/o Graph | 0.001345 | 0.8012 | 66.8% | 0.1101 | 0.1034 | 0.023789 | 0.036234 |
| w/o MATCC | 0.001567 | 0.7654 | 63.4% | 0.0876 | 0.0812 | 0.025123 | 0.039567 |
| w/o Market Guidance | 0.001432 | 0.7987 | 66.1% | 0.1089 | 0.1012 | 0.024234 | 0.037890 |

**说明**：
- **前5列**（MSE, R², Dir. Acc., IC, RankIC）是核心指标，必须展示
- **IC 和 RankIC** 是量化金融领域的标准指标，能显著提升论文专业性
- **后2列**（MAE, RMSE）是补充指标，提供更直观的误差度量
