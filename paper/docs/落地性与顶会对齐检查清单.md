# 代码与论文落地性检查清单（含顶会对齐）

本文档对照**同方向顶会**（如 AAAI/KDD 金融时序、GNN 预测）的常见要求，对当前代码与论文的「可运行、可复现、可得到预期结果」做一次审计，并列出已修复项与建议。

---

## 一、顶会/量化方向常见要求（简要）

- **可复现性**：固定随机种子、明确数据切分与时间截断、代码/超参数与论文一致（AAAI 等有 Reproducibility Checklist）。
- **无未来信息**：构图、特征、标签均严格按时间截断（如 split_date=2020-12-31），测试集为 2021–2023。
- **评估规范**：预测能力用 RankIC/ICIR；回测用 Top-K 多空、年化收益、夏普、最大回撤；必要时按日截面算 IC 再平均。
- **消融设计**：无图 vs 有图、不同时序编码器（LSTM vs RWKV）、不同图（静态/统计/语义+统计）等。

当前实现与上述要求的对应关系见下。

---

## 二、已满足或已对齐的部分

| 项目 | 状态 | 说明 |
|------|------|------|
| 时间截断与防泄露 | ✅ | 构图 `--split_date 2020-12-31`；新闻/统计图均只用该日前数据；图谱一次性构建、全阶段静态使用。 |
| 训练/验证/测试时间范围 | ✅ | 训练 2018-01-01～2020-12-31；验证在训练阶段内由 `test_loader` 担任早停监控；**测试集 2021-01-01～2023-12-31**（已在 `train_full.py` 的 `PAPER_CONFIG` 中设置 `test_start`/`test_end`）。 |
| 评估指标 | ✅ | RankIC、ICIR、MSE、方向准确率；Top-K 回测（年化、夏普、最大回撤）；`4_evaluate.py` 与论文 §5.1 一致。 |
| 消融入口 | ✅ | `3_train_ablation.py` 支持无图、仅统计图、仅语义图等；`temporal_backend` 支持 rwkv/lstm/gru。 |
| 节点对齐 | ✅ | `Graph_Tickers.json` 与 `FinancialDataset.ticker2idx` 一致；训练前校验邻接矩阵形状与节点数，防止静默错位。 |
| 损失与训练策略 | ✅ | MSE + RankIC 损失；按日成批（DateGroupedBatchSampler）；早停、checkpoint 保存；与论文 §3.3、§4.3 一致。 |
| 超参数与脚本对应 | ✅ | 论文正文可落地版 §4.3 与 `PAPER_CONFIG`、`build_graph.py`、`3_train.py` 一一对应。 |

---

## 三、已修复的问题

1. **测试集时间范围未显式设置**  
   - **问题**：`PAPER_CONFIG` 中 `test_start`/`test_end` 为 `None` 时，`FinancialDataset` 会退化为「全量数据 80/20 时间切分」，测试集未必严格等于 2021–2023。  
   - **修复**：在 `training/train_full.py` 的 `PAPER_CONFIG` 中已设置 `test_start='2021-01-01'`、`test_end='2023-12-31'`，与论文 3.3 节一致。

---

## 四、运行与复现时需注意的事项

1. **工作目录**  
   - 入口脚本（`1_preprocess_data.py`、`2_build_graph.py`、`3_train.py`、`4_evaluate.py`）已改为基于 **脚本所在目录**（`__file__`）解析路径，因此**在 `paper/` 目录下**执行即可：  
     `cd paper && python 1_preprocess_data.py`、`python 2_build_graph.py`、`python 3_train.py`、`python 4_evaluate.py`。  
   - **run_all.py**：在 `paper/` 下运行 `python run_all.py`，会依次调用上述脚本；评估阶段使用的 checkpoint 与 test_data 路径也已改为基于脚本目录。

2. **建图全量跑**  
   - 调试时若设置了 `DEBUG_MAX_NEWS = 2000`，正式复现前请改为 `DEBUG_MAX_NEWS = 0`，否则只处理前 2000 条新闻。

3. **数据与依赖**  
   - 需先有 ETL 产物：`Final_Model_Data.csv`、`Stock_News_sp500.csv`（或过滤后新闻）、`feature_columns.json` 等；建图依赖 `dataProcessed/build_graph.py` 的入口（如 `2_build_graph.py --llm`）与正确 `--split_date`。  
   - 环境需具备：PyTorch、torch_geometric（可选）、pandas、transformers（LLM 建图）等，见 `README.md` 或 `requirements.txt`。

4. **实际跑通一次**  
   - 建议在目标环境上**完整跑通**：数据预处理 → 建图 → 训练 → 评估；确认无报错、测试集为 2021–2023、评估脚本输出 RankIC/ICIR 与回测指标。  
   - 若使用 48GB GPU，可设 `QL_PROFILE=48gb` 以启用更大 batch 等（见 `train_full.py`）。

---

## 五、结论（能否落地、能否得到想要结果）

- **论文**：当前论文正文（`论文正文_可落地版.md`）与 new.md、与代码设计一致；时间切分、构图流程、评估指标、消融设计均满足「可落地」描述；**实验数据（§5.3 结果与讨论）需在跑完实验后填写**。  
- **代码**：  
  - **能正常运行**：在具备数据与依赖、工作目录与路径正确、`DEBUG_MAX_NEWS=0` 的前提下，从预处理到建图、训练、评估的流程可以跑通，并与论文描述一致。  
  - **能得到想要的结果**：这里「想要的结果」指：  
    1）**流程结果**：训练收敛、保存 checkpoint、评估输出 RankIC/ICIR 与回测指标；  
    2）**学术结果**：是否显著优于 Base、是否在 2021–2023 上达到预期水平，取决于数据质量、超参与随机性，需通过实际实验与消融验证。  
- **与顶会习惯对齐**：时间截断、无未来信息、固定测试集 2021–2023、RankIC/回测、消融入口、超参与脚本对应均已就绪；补全 §5.3 结果并按要求提供代码/数据说明后，即可满足同方向顶会对「可复现、可落地」的常规预期。

**一句话**：在按上述「运行与复现注意事项」操作、并补全实验数据的前提下，**代码可以正常运行并得到与论文一致的评估结果**；论文与代码均可视为可落地，并与同方向顶会常见规范对齐。
