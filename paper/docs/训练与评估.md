# 训练与评估指南

> 模型训练、消融实验、评估分析完整指南

## 完整模型训练

### 文件: `training/train_full.py`

### 关键配置

```python
CONFIG = {
    # 模型维度
    'n_embd': 256,          # 嵌入维度
    'n_layers': 3,          # RWKV层数
    'gnn_embd': 64,         # GNN嵌入维度
    
    # 训练参数
    'batch_size': 512,      # 批次大小
    'epochs': 20,           # 训练轮数
    
    # 学习率（差异化）
    'lr': 3e-4,            # 经典层学习率
    'quantum_lr_ratio': 0.1, # 量子层=3e-5
    
    # 正则化
    'dropout': 0.15,
    'weight_decay': 1e-5,
    
    # 动态阈值
    'q_threshold': None    # 从dataset自动获取p70
}
```

### 训练流程

1. **数据加载**: 使用`FinancialDataset`加载训练/测试集
2. **动态阈值**: 从训练集获取`q_threshold = train_dataset.vol_stats['p70']`
3. **模型构建**: `QL_MATCC_GNN_Model`，传入动态阈值
4. **差异化优化器**: 量子层3e-5, 经典层3e-4
5. **调度器**: `CosineAnnealingWarmRestarts`
6. **训练**: 混合精度(AMP) + 梯度裁剪 + Early Stopping

### 输出

- `outputs/checkpoints/best_model_full.pth` - 最佳模型
- `outputs/logs/training_losses_full.json` - 训练历史
- `outputs/figures/training_curve_full.png` - 损失曲线

**运行时间**: 约2-4小时

---

## 消融实验

### 文件: `training/train_ablation.py`

### 实验设计

3组消融实验，验证各模块有效性：

1. **no_quantum** - 移除量子模块
2. **no_matcc** - 移除趋势解耦
3. **no_graph** - 移除图神经网络

**注意**: Full Model 基准请单独运行 `training/train_full.py`

### 运行

```bash
python -m training.train_ablation
```

**运行时间**: 约6-12小时（3个实验 × 20 epochs）

### 输出

- 3个最佳模型权重
- 3个训练历史JSON
- `ablation_results_summary.csv` - 汇总表
- `ablation_comparison.png` - 对比图

---

## 模型评估

### 文件: `evaluation/evaluate_all.py`

### 评估指标

#### 1. 统计误差

- **MSE**: 均方误差
- **RMSE**: 均方根误差
- **MAE**: 平均绝对误差
- **R²**: 决定系数

#### 2. 方向准确率

- 预测涨跌方向的准确率

#### 3. IC和RankIC (核心)

```python
from scipy.stats import pearsonr, spearmanr

# IC: 预测值与真实值的线性相关性
IC, _ = pearsonr(y_pred, y_true)

# RankIC: 预测排名与真实排名的相关性
RankIC, _ = spearmanr(y_pred, y_true)
```

**重要性**:
- IC > 0.05: 有投资价值
- RankIC > 0.10: 优秀的选股能力

### 评估流程

1. 加载所有模型
2. 在测试集上预测
3. 计算所有指标
4. 生成对比表和可视化

### 输出

- `evaluation_overall.csv` - 整体指标对比
- `evaluation_comparison.png` - 可视化对比

---

## 分组评估

### 文件: `evaluation/evaluate_by_group.py`

按波动率分为3组（Low, Medium, High），分别评估：

```python
groups = pd.qcut(volatility, q=3, labels=['Low', 'Medium', 'High'])
```

**分析价值**:
- Low波动: 量子模块不激活
- High波动: 量子模块激活，Full Model应优于no_quantum

### 输出

- `evaluation_by_volatility.csv` - 分组评估结果

---

## 超参数调优

### 学习率

```python
learning_rates = [1e-5, 3e-5, 1e-4, 3e-4, 1e-3]
```

推荐: 经典层3e-4, 量子层3e-5

### Batch Size

```python
batch_sizes = [128, 256, 512, 1024]
```

推荐: 512 (平衡速度和性能)

### 模型容量

```python
# 小模型（快速实验）
{'n_embd': 128, 'n_layers': 2}

# 中模型（推荐）
{'n_embd': 256, 'n_layers': 3}

# 大模型（性能优先）
{'n_embd': 512, 'n_layers': 4}
```

---

## 常见问题

### Q1: Loss不下降

**解决方案**:
```python
# 降低学习率
CONFIG['lr'] = 1e-4

# 检查数据标准化
print(train_dataset.data.describe())
```

### Q2: 过拟合

**解决方案**:
```python
# 增加正则化
CONFIG['dropout'] = 0.2
CONFIG['weight_decay'] = 1e-4

# Early Stopping
CONFIG['early_stop_patience'] = 3
```

### Q3: 显存不足

**解决方案**:
```python
# 减小Batch Size
CONFIG['batch_size'] = 256

# 减小模型维度
CONFIG['n_embd'] = 128

# 关闭图神经网络
CONFIG['use_graph'] = False
```

### Q4: 训练太慢

**解决方案**:
```python
# 混合精度训练
CONFIG['use_amp'] = True

# 增加num_workers
CONFIG['num_workers'] = 8

# 减小模型容量
CONFIG['n_embd'] = 128
```

---

## 性能基准

### 期望结果（测试集）

| 模型 | MSE | IC | RankIC | Dir.Acc |
|------|-----|---------|---------|---------|
| Full Model | 0.00145 | 0.092 | 0.114 | 54.2% |
| w/o Quantum | 0.00152 | 0.085 | 0.105 | 53.5% |
| w/o Graph | 0.00168 | 0.075 | 0.095 | 52.8% |
| w/o MATCC | 0.00178 | 0.068 | 0.087 | 52.1% |

**评价标准**:
- IC > 0.05: 有投资价值
- RankIC > 0.10: 优秀的选股能力
- Dir.Acc > 52%: 超过随机猜测

---

## 总结

**训练流程**: 数据加载 → 动态阈值 → 差异化优化器 → 训练循环 → Early Stopping

**关键技术**:
1. 动态量子阈值（p70百分位）
2. 差异化学习率（量子/经典分离）
3. 混合精度训练（AMP）
4. Cosine Annealing调度器

**评估指标**: IC/RankIC为核心，辅以MSE、方向准确率

**运行时间**: Full Model 2-4小时，消融实验 6-12小时
