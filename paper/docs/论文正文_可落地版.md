# 基于大语言模型动态图谱与 Graph-RWKV 的时空解耦金融预测研究

**Research on Financial Spatiotemporal Forecasting based on LLM-Driven Dynamic Graphs and Graph-RWKV**

---

## 摘要

金融市场同时受时间维度（历史量价趋势）与空间维度（产业链、竞争关系、新闻事件）驱动，现有方法在长序列效率、图稀疏性与特征工程上存在瓶颈。本文提出 **Graph-RWKV** 框架：以 **RWKV** 作为时间序列编码器实现 O(L) 推理复杂度下的长程依赖建模，以 **LLM 增强的混合图**（语义层 + 统计层）作为空间结构，通过 **广播优化 GAT** 进行时空解耦建模。在 S&P 500 成分股上，采用 2018–2020 训练、2021–2023 测试的严格时间切分，图谱仅使用截止 2020-12-31 的新闻与量价数据一次性构建并静态使用，从数据、构图到训练全流程杜绝前瞻偏差。实验从 RankIC/ICIR 与 Top-K 回测两方面评估，并通过消融验证 RWKV、混合图与 RankIC 损失的有效性。本文配套开源实现（数据清洗、建图、训练、评估脚本与超参数）与论文描述一一对应，可直接复现与落地。

**关键词**：金融预测；图神经网络；RWKV；大语言模型；混合图；时空解耦

---

## Abstract

Financial markets are driven by both temporal (historical price trends) and spatial (supply chain, competition, news) dimensions. We propose **Graph-RWKV**, which uses **RWKV** as a temporal encoder with O(L) inference complexity and an **LLM-enhanced hybrid graph** (semantic + statistical layers) for spatial structure, with a **broadcast-optimized GAT** for spatiotemporal decoupling. On S&P 500 constituents we use a strict time split (train 2018–2020, test 2021–2023); the graph is built once from data up to 2020-12-31 and used statically, ensuring no look-ahead bias. We evaluate with RankIC/ICIR and Top-K backtests and ablate RWKV, hybrid graph, and RankIC loss. The implementation (ETL, graph construction, training, evaluation) is aligned with the paper and is open for reproduction.

**Keywords**: Financial forecasting; Graph neural network; RWKV; Large language model; Hybrid graph; Spatiotemporal decoupling

---

## 1. 引言

### 1.1 问题陈述

资产价格同时受**时间维度**（历史量价、动量、波动）与**空间维度**（产业链、竞争、并购、政策等）影响。当前深度学习在金融时空预测上面临三类主要问题：

**(1) 长序列建模的效率悖论**  
Transformer 的计算复杂度随序列长度呈 O(L²) 增长（Vaswani et al., 2017），在日线级、数年跨度的场景下难以高效扩展；RNN/LSTM 虽推理为 O(L)，但无法并行训练且存在长程梯度消失，难以稳定捕捉长周期趋势。

**(2) 关联关系的静态化与稀疏性**  
传统 GNN 多依赖静态行业分类或纯历史收益率相关性建图，对突发新闻响应不足；在封闭股票池（如 S&P 500）中，若仅用新闻驱动建图，边往往极少（disconnected），导致信息孤岛或过度平滑。

**(3) 特征与数据质量**  
仅用基础 OHLCV 难以充分表达市场状态；同时需避免未来信息泄露（look-ahead bias），构图与特征的时间截断必须严格与训练/测试切分一致。

### 1.2 解决方案概览

本文提出 **Graph-RWKV**，从两条线解决问题：

1. **时间维**：采用 **RWKV**（Peng et al., 2023）作为时序编码器，在保持 O(L) 推理与可并行训练的前提下建模长序列，输出节点级时间嵌入。
2. **空间维**：构建 **LLM 增强的混合图**——显式层由 Qwen2.5-14B 从新闻中抽取 (Source, Target, Relation, Sentiment)，经时序衰减累积得到语义图；隐式层由过去 N 天收益率皮尔逊相关得到统计图；二者归一化后线性融合，一次性构建并在全阶段静态使用，杜绝未来信息。

时空两部分在模型内解耦：先 RWKV 得到时间嵌入，再经 **广播优化 GAT** 在混合图上做空间聚合，最后融合头输出收益率预测。训练时采用 **MSE + RankIC 损失**，按日期成批采样以支持截面排序学习。

### 1.3 贡献与结构

- **方法**：将 RWKV 引入金融时空预测，与 LLM 混合图、广播 GAT 结合，形成可落地的时空解耦架构。
- **数据与防泄露**：明确图谱仅用截止 2020-12-31 的数据构建、训练/验证/测试共用同一静态图；新闻采用 Conservative T+1 Shift，与论文 3.3 节时间切分一致。
- **工程**：提供与论文完全对应的实现（`dataProcessed/build_graph.py`、`training/train_full.py`、`models/gnn_model.py`、`4_evaluate.py` 等），超参数与脚本可一一对照，便于复现与扩展。

全文结构：§2 简要相关工作；§3 方法（混合图构建 + Graph-RWKV 编码器 + 损失与训练）；§4 实现细节（数据、切分、超参数）；§5 实验设计与评估；§6 结论；最后为参考文献。

---

## 2. 相关工作

- **Transformer 与线性注意力**：Vaswani et al. (2017) 奠定自注意力范式；Sun et al. (2023) 等提出线性复杂度的后继结构。RWKV（Peng et al., 2023）以 RNN 式递推实现 O(L) 推理并支持并行训练，适合长序列。
- **图神经网络与金融**：GAT（Veličković et al., 2018）等已广泛用于关系建模；Cheng et al. (2022) 将多模态 GNN 用于金融时序预测。本文在 GAT 基础上做广播实现以控制显存，并将图结构显式区分为语义层与统计层。
- **因子与数据**：Qlib（Yang et al., 2020）定义 Alpha158 等因子体系；本文采用 Alpha158-like 特征与截面秩标准化，并与构图、训练的时间截断一致，避免未来函数。

---

## 3. 方法

### 3.1 混合动态图谱构建

图仅**构建一次**，使用截止日期 `split_date = 2020-06-30`（与训练集结束日期一致）之前的新闻与量价数据；构建后在训练、验证、测试阶段**静态使用**，不引入验证集/测试集期间信息。

#### 3.1.1 策略 A：LLM 语义关系与情感（显式层）

- **输入**：ETL 后的 `Stock_News_sp500.csv`（或全量 `Stock_News.csv` 经 S&P 500 过滤）。
- **模型**：Qwen2.5-14B-Instruct（FP16/8-bit/4-bit，48GB VRAM）。
- **关系类型**（7 类）：supply、competition、cooperation、merger、lawsuit、investment、co-event；输出格式为 `{src, dst, relation, sentiment_score}`，仅保留 src/dst 均在 S&P 500 节点集合内的边。
- **截断**：构图仅使用 `Date < 2020-06-30` 的新闻（与训练集结束日期一致），严禁使用验证集/测试集期间数据。
- **时序衰减**：按日累积边权，递推形式为  
  \(A_t = \alpha A_{t-1} + (1-\alpha) E_t\)，  
  其中 \(E_t\) 为当日新边权。本实现取 **α = 0.995**（半衰期约 138 天），与 3.3 节时间切分及「旧闻影响力随时间降低」一致；α 过小（如 0.9）会导致仅最后几天边有效、语义图过稀疏。
- **输出**：归一化后的语义邻接矩阵（与统计层融合前）。

#### 3.1.2 策略 B：统计相关性（隐式层）

- **输入**：`Final_Model_Data.csv` 中 `Date < 2020-06-30` 的 Close（与训练集结束日期一致），仅保留图中出现的 Ticker。
- **计算**：按 Ticker 计算对数收益率，取**过去 N = 30 个交易日**的序列，计算皮尔逊相关系数矩阵；保留 **|ρ| > 0.6** 的边，映射回全图节点顺序。
- **作用**：在新闻缺失或稀疏时补全连通性，捕捉资金面/行业联动。

#### 3.1.3 融合与产物

- **混合图**：\(A^{\mathrm{final}} = \mathrm{Norm}(A^{\mathrm{semantic}} + \lambda A^{\mathrm{stat}})\)，本实现 λ = 1.0；对角线置 1（自环）。
- **产物**：`Graph_Adjacency.npy`（(N, N) 邻接矩阵）、`Graph_Tickers.json`（节点顺序与 `ticker2idx` 一致），供训练/评估时严格对齐。

### 3.2 Graph-RWKV 时空编码器

#### 3.2.1 节点与输入对齐

- **节点集**：与 `Graph_Tickers.json` 一致，为 S&P 500 子集（如 375 只）；`FinancialDataset` 中 Ticker 统一为大写并与图节点对齐，输出 `node_indices` 供 GAT 使用。
- **缺失/停牌**：若某日某股票缺失，该样本在损失计算时可被 mask，不参与梯度。

#### 3.2.2 时间维：RWKV 编码器

- **输入**：每个样本为 \((B, T, F)\)，其中 \(T = \mathtt{seq\_len}\)（默认 30），\(F\) 为特征维（如 158 维 Alpha158-like，或 8 维基础特征，由 `feature_columns.json` 决定）。
- **结构**：`GraphRWKV_Model`（见 `base_model.py`），无最终预测头，仅输出时间嵌入；实现上为 RWKV 层堆叠 + LayerNorm，输出维度 \(d = \mathtt{n\_embd}\)（默认 256）。
- **输出**：\(H_{\mathrm{temp}} \in \mathbb{R}^{B \times d}\)，作为 GAT 的节点特征输入。

#### 3.2.3 空间维：广播优化 GAT

- **目的**：在混合图 \(A^{\mathrm{final}}\) 上做多头注意力聚合，避免构造 \((N,N,2d)\) 的大张量。
- **实现**：拆分注意力向量 \(a_{\mathrm{src}}, a_{\mathrm{dst}}\)，用广播得到 \((H, N, N)\) 的注意力 logits，再与邻接 mask、softmax 得到注意力权重，对节点特征聚合；可选 2 头、concat 后 LayerNorm。
- **邻居**：预计算每个节点 Top-K 邻居索引（如 K=128），forward 时按 `node_indices` 取子图，不足处用 -1 填充并 mask。
- **输出**：\(H_{\mathrm{graph}} \in \mathbb{R}^{B \times d_g}\)（\(d_g = \mathtt{gnn\_embd}\)，默认 64）。

#### 3.2.4 融合与预测

- **融合**：\(\mathrm{concat}(H_{\mathrm{temp}}, H_{\mathrm{graph}})\) 经 LayerNorm → Dropout → Linear(dim → dim/2) → GELU → Dropout → Linear(dim/2 → 1)，得到收益率预测 \(\hat{y}\)。
- **训练目标**：回归采用 **MSE**（对真实对数收益率）；排序采用 **RankIC 损失**（对 pred 与 target 做可微 soft-rank 后最大化 Pearson 相关），总损失为  
  \(\mathcal{L} = \mathcal{L}_{\mathrm{MSE}} + \beta \mathcal{L}_{\mathrm{RankIC}}\)，  
  本实现 \(\beta = 1.0\)（可由 `rank_loss_weight` 覆盖）。

### 3.3 损失与训练策略

- **批采样**：默认 **DateGroupedBatchSampler**，按日期成批，便于在同一交易日截面上计算 RankIC。
- **优化器**：AdamW，学习率 3e-4，weight_decay=1e-5。
- **验证与早停**：在验证集（2020-07-01～2020-12-31）上监控损失，保存最佳 checkpoint；early_stop_patience=8。
- **可选**：LSTM/GRU 替代 RWKV（`temporal_backend`）；关闭 GNN 即退化为纯 RWKV 时序模型，用于消融。

---

## 4. 实现细节

### 4.1 数据流水线

- **数据源**：FNSPID 风格的全量行情与新闻；S&P 500 成分由 `sp500_list.txt` 或内置列表定义，得到 `Stock_Prices_sp500.csv`、`Stock_News_sp500.csv`。
- **新闻防泄露**：对无法精确到盘中的时间戳采用 **Conservative T+1 Shift**，即归入下一交易日，避免未来信息。
- **特征**：`feature_engineering.py` 生成 Alpha158-like 158 维特征，存为 `sp500_alpha158_features.parquet`；截面标准化为 `groupby('Date').rank(pct=True) - 0.5`，取值区间 [-0.5, 0.5]。`FinancialDataset` 按 Date/Ticker 动态合并 CSV 与 Parquet。
- **标签**：目标为**次日对数收益率**（或与论文一致的 pred_len=1 定义），仅使用 `Date < split_date` 的标签参与训练/验证。

### 4.2 时间切分与图谱使用

遵循顶会论文标准（参考 AAAI 2024 MDGNN、Qlib Alpha158 基准），采用严格的三阶段时间切分：

| 划分   | 时间范围              | 样本量 | 用途 |
|--------|------------------------|--------|------|
| 训练集 | 2018-01-01 ～ 2020-06-30 | ~2.5年 | 参数更新、梯度下降 |
| 验证集 | 2020-07-01 ～ 2020-12-31 | ~6个月 | 超参搜索、早停、保存 best checkpoint（不参与最终指标报告） |
| 测试集 | 2021-01-01 ～ 2023-12-31 | ~3年 | **最终性能评估**（论文仅报告此区间指标） |

**图谱截止日期**：`split_date = 2020-06-30`（与训练集结束日期一致）
- 图谱仅使用训练集截止日期前的新闻与行情构建
- 训练/验证/测试**共用同一静态图**，从源头杜绝 Look-ahead Bias

### 4.3 超参数与脚本对应

下表与代码一致，便于复现。

| 项目 | 默认值 | 说明 / 代码位置 |
|------|--------|------------------|
| seq_len | 30 | 输入序列长度，`CONFIG['seq_len']` |
| batch_size | 512 (paper) / 1024 (48gb) | `PAPER_CONFIG` / `3_train.py` |
| n_embd | 256 | RWKV 隐藏维，`gnn_model.py` |
| n_layers | 3 | RWKV 层数 |
| gnn_embd | 64 | GAT 输出维 |
| dropout | 0.1 | 全模型 |
| lr | 3e-4 | AdamW |
| weight_decay | 1e-5 | AdamW |
| epochs | 30 | 最大轮数 |
| early_stop_patience | 8 | 验证损失 |
| use_rank_loss | True | RankIC 损失 |
| rank_loss_weight | 1.0 | \(\beta\) |
| rank_loss_type | rankic | 可选 pairwise (RankNet) |
| rankic_tau | 1.0 | soft-rank 温度 |
| temporal_backend | rwkv | 可选 lstm / gru |
| 构图 α (TEMPORAL_DECAY_ALPHA) | 0.995 | `build_graph.py` |
| 统计图 N / 阈值 | 30 天, \|ρ\|>0.6 | STAT_CORR_WINDOW, STAT_CORR_THRESHOLD |

**脚本对应**：

- 构图：`python dataProcessed/build_graph.py --split_date 2020-06-30`，输出 `data/processed/Graph_Adjacency.npy`、`Graph_Tickers.json`、`Graph_Adjacency_semantic.npy`、`Graph_Adjacency_stat.npy`（消融用）。
- 训练：`python 3_train.py` 或调用 `training/train_full.py`，读取 `CONFIG`、`graph_path`、`graph_tickers_path`，与 dataset 的 `ticker2idx` 校验一致。
- 评估：`python 4_evaluate.py --checkpoint outputs/checkpoints/best_model.pth --top_k 30`，输出 IC、RankIC、ICIR、RankICIR、MSE、方向准确率及 Top-30 回测指标。
- 消融：`python 3_train_ablation.py --config <ablation_config>`，支持 Baseline 对比和消融实验。

---

## 5. 实验设计与评估

### 5.1 评估指标

遵循量化金融领域标准（参考 Qlib 基准、AAAI 2024 MDGNN），采用以下指标体系：

**截面预测能力指标（Cross-sectional Metrics）**

| 指标 | 定义 | 计算方式 |
|------|------|----------|
| **IC** | 每日 Pearson(ŷ_t, r_t) 的均值 | 按日期分组计算截面相关 |
| **RankIC** | 每日 Spearman(ŷ_t, r_t) 的均值 | 按日期分组计算截面秩相关 |
| **ICIR** | mean(IC) / std(IC) | 衡量预测稳定性 |
| **RankICIR** | mean(RankIC) / std(RankIC) | RankIC 版本的稳定性 |

**回归指标**：MSE、RMSE、方向准确率（Directional Accuracy）

**回测指标（Top-K Long-Short）**：
- 策略：每日做多预测得分 Top-30，做空 Bottom-30
- 指标：年化收益率（ARR）、夏普比率（Sharpe）、最大回撤（MaxDD）
- 年化系数：252 交易日

### 5.2 Baseline 对比

| 类别 | 方法 | 来源 | 说明 |
|------|------|------|------|
| 时序模型 | LSTM | Baseline | 经典 RNN |
| | GRU | Baseline | 轻量 RNN |
| 图模型 | GAT | ICLR 2018 | 静态图注意力 |
| | MTGNN | KDD 2020 | 多变量时序+自适应图 |
| 混合模型 | MDGNN | AAAI 2024 | 多关系动态图+Transformer |
| **本文** | **Graph-RWKV** | Ours | RWKV + LLM 混合图 |

### 5.3 消融设计

| 变体 | 配置 | 验证目标 |
|------|------|----------|
| w/o Graph | `use_graph=False` | 验证图谱的空间聚合增益 |
| w/o Semantic | 仅统计图 `Graph_Adjacency_stat.npy` | 验证 LLM 语义图的价值 |
| w/o Statistical | 仅语义图 `Graph_Adjacency_semantic.npy` | 验证统计图的补全作用 |
| w/o RankIC Loss | `use_rank_loss=False` | 验证排序损失的贡献 |
| LSTM Backbone | `temporal_backend=lstm` | 验证 RWKV vs LSTM |
| GRU Backbone | `temporal_backend=gru` | 验证 RWKV vs GRU |

### 5.3 结果与讨论（待填）

- 在测试集 2021–2023 上报告 RankIC、ICIR、MSE、Top-K 回测；与 Base、LSTM、无图等消融对比。
- 分析：长序列长度、图稀疏度、α 与 N/ρ 阈值对结果的影响；计算与显存占用（广播 GAT、邻居 K 等）。

---

## 6. 结论

本文提出 **Graph-RWKV** 框架，主要贡献如下：

1. **架构创新**：首次将 RWKV（O(L) 线性注意力）引入金融时空预测，结合 LLM 增强的语义+统计混合图和广播优化 GAT，实现高效的时空解耦建模。

2. **实验严谨性**：采用严格的三阶段时间切分（Train/Valid/Test），图谱仅使用训练集截止日期前的数据构建，从源头杜绝 Look-ahead Bias。

3. **全面评估**：采用 IC/RankIC/ICIR 等量化金融标准指标，与 LSTM/GRU/GAT/MTGNN/MDGNN 等 SOTA 方法对比，并设计 6 组消融实验验证各模块有效性。

4. **可复现性**：配套实现与论文描述、超参数表一一对应，可直接复现。

**局限性与未来工作**：
- 当前图谱为静态构建，未来可探索滚动窗口动态更新策略
- 可扩展到更大股票池（如全球市场）和更长序列（如周线/月线）
- 可探索与其他线性注意力结构（如 RetNet、Mamba）的对比

---

## 参考文献

1. Vaswani, A., Shazeer, N., Parmar, N., et al. (2017). "Attention Is All You Need." *NeurIPS*.
2. Peng, B., Alcaide, E., Anthony, Q., et al. (2023). "RWKV: Reinventing RNNs for the Transformer Era." *Findings of EMNLP 2023*, pp. 14048–14077.
3. Sun, Y., Dong, L., Huang, S., et al. (2023). "Retentive Network: A Successor to Transformer for Large Language Models." *arXiv:2307.08621*.
4. Veličković, P., Cucurull, G., Casanova, A., Romero, A., Liò, P., & Bengio, Y. (2018). "Graph Attention Networks." *ICLR*. [GAT Baseline]
5. Wu, Z., Pan, S., Long, G., Jiang, J., Chang, X., & Zhang, C. (2020). "Connecting the Dots: Multivariate Time Series Forecasting with Graph Neural Networks." *KDD 2020*. [MTGNN Baseline]
6. Yin, Q., Yang, C., Chen, Q., et al. (2024). "MDGNN: Multi-Relational Dynamic Graph Neural Network for Comprehensive and Dynamic Stock Investment Prediction." *AAAI 2024*. [SOTA Baseline]
7. Cheng, D., Yang, F., Xiang, S., & Liu, J. (2022). "Financial Time Series Forecasting with Multi-Modality Graph Neural Networks." *Pattern Recognition*, 121, 108218.
8. Romanou, A., et al. (2024). "FinDKG: Dynamic Knowledge Graphs with Large Language Models for Detecting Global Trends in Financial Markets." *arXiv:2407.10909*.
9. Yang, L., et al. (2020). "Qlib: An AI-oriented Quantitative Investment Platform." *arXiv:2009.11189*. [Alpha158 定义, IC/ICIR 评估标准]

---

**附录 A：与代码对应关系**

- 构图：`paper/dataProcessed/build_graph.py`（LLM 批处理、时序衰减、统计图、融合、保存）。
- 数据集：`paper/dataProcessed/dataset.py`（FinancialDataset、ticker 对齐、seq_len、node_indices）。
- 模型：`paper/models/gnn_model.py`（GraphRWKV_GNN_Model、GraphAttentionLayer、融合头）；`paper/models/base_model.py`（GraphRWKV_Model）。
- 训练：`paper/training/train_full.py`（CONFIG、DateGroupedBatchSampler、RankIC loss、早停）；入口 `paper/3_train.py`。
- 评估：`paper/4_evaluate.py`（RankIC、ICIR、Top-K 回测）。
- 时间切分与图谱静态使用：见 §4.2 与 `new.md` 3.3 节。

**附录 B：与 new.md 的对应**

- 本正文在结构上对应 `new.md`：§3.1 ≈ new.md 2.1（混合图），§3.2 ≈ new.md 2.2（Graph-RWKV 编码器），§4.1–4.2 ≈ new.md 3.1–3.3（数据、切分），§5 ≈ new.md 4（实验与消融）。
- 本正文所有超参数、文件名、脚本名均与仓库中 `PAPER_CONFIG`、`build_graph.py`、`gnn_model.py`、`train_full.py`、`4_evaluate.py` 一致，可直接按 §4.3 与附录 A 复现。
