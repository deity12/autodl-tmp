# 语义图 vs 统计图：含义与来源

## 一、语义图（19 条边）

### 含义
- **一条边** = 两只股票之间被**新闻显式提到**的某种**业务/事件关系**，且经过时间衰减后的累积强度非零。
- **19 条边** = 在 375 只 S&P 500 节点中，只有 **19 对** 股票在“语义层”上被连在一起（无向，所以 19 条边对应 19 对）。

### 怎么得来的（流程）

1. **数据**  
   - 输入：`Stock_News_sp500.csv` 中、且 **Date < 2020-12-31** 的新闻（防泄露）。  
   - 对每条新闻做**分层采样**（每股最多 200 条、总上限 10 万），得到约 85,878 条新闻用于建图。

2. **LLM 关系抽取**  
   - 用 **Qwen2.5-14B** 对每条新闻标题做关系抽取。  
   - 每条新闻输出若干三元组：`(src, dst, relation, sentiment_score)`。  
   - 关系类型限定为 7 类：supply / competition / cooperation / merger / lawsuit / investment / co-event。  
   - 只保留 **src、dst 都在当前图节点（375 只 S&P 500）** 的边。

3. **时间衰减累积**  
   - 按**日期**对边权重做指数衰减累积：  
     - 公式：`A_t = α·A_{t-1} + (1-α)·(当日新边)`，代码里 `α = 0.995`。  
   - 依据论文 new.md：2.1 节要求「采用指数衰减因子，确保旧闻的影响力随时间降低」；3.3 节时间切分下，图截止 2020-12-31，语义图新闻约覆盖 2018–2020（约 3 年）。α=0.995 半衰期约 138 天，在 3 年窗口内 1–2 年前新闻仍保留有效权重，满足 2.1 节且避免衰减过猛。  
   - 旧新闻的贡献随时间衰减，只保留“有效”的边权重。

4. **归一化与边数统计**  
   - 对语义邻接矩阵做归一化（除以最大值），然后去掉自环，统计  
     `(矩阵元素和 - 节点数) / 2` = **无向边数** = 你看到的 **19**。

### 为什么只有 19 条边？
- 很多新闻只提一家公司，LLM 直接返回 `[]`。  
- 不少抽取出的 (src, dst) 里至少有一个不在 S&P 500 节点集合里，被过滤掉。  
- 时间衰减后，弱边被压得很小，再经归一化/阈值等效后，只留下 19 对“强”语义关系。  
- 所以语义图是**显式、稀疏**的“新闻里写出来的关系”。

---

## 二、统计图（2760 条边）

### 含义
- **一条边** = 两只股票在**过去一段时间内的收益率**高度相关，即走势“同步”，被认为在**隐式层**有关联（资金/行业/因子联动等）。  
- **2760 条边** = 在 375 只节点中，有 **2760 对** 股票满足“强相关”条件（无向边数）。

### 怎么得来的（流程）

1. **数据**  
   - 输入：`Final_Model_Data.csv` 里的 **Date, Ticker, Close**。  
   - 只保留 **Date < 2020-12-31** 的行情（防泄露）。  
   - 只保留图中存在的 375 只股票的行情。

2. **收益率**  
   - 按 Ticker 分组，计算**对数收益率**：  
     `Log_Ret = log(Close_t / Close_{t-1})`。

3. **相关系数**  
   - 取**最近 30 个交易日**（`STAT_CORR_WINDOW = 30`）的收益率序列。  
   - 对每只股票，若有效数据 ≥ 80% 窗口长度，则纳入；得到 289 只“有效股票”。  
   - 对这 289 只的收益率序列做 **皮尔逊相关系数矩阵** `Corr(i,j)`。

4. **二值化与映射回全图**  
   - 设定阈值 `STAT_CORR_THRESHOLD = 0.6`。  
   - 若 `|Corr(i,j)| > 0.6`，则在**统计图**里给 (i,j) 一条边（无向、先记 0/1）。  
   - 把这 289×289 的邻接关系，按 `ticker2idx` **映射回 375×375** 的全图（其余节点对为 0）。  
   - 边数 = `(矩阵元素和 - 节点数) / 2` = **2760**（无向）。

### 为什么有 2760 条边？
- 用**纯量价数据**，不依赖新闻；只要两只股票过去 30 天收益率高度相关就连边。  
- 0.6 的阈值会保留较多“强相关”对，所以边数远多于语义图。  
- 反映的是**隐式、资金/市场联动**，和“新闻里写出来的关系”互补。

---

## 三、对比小结

| 项目       | 语义图（19 条边）           | 统计图（2760 条边）              |
|------------|-----------------------------|----------------------------------|
| **含义**   | 新闻中显式提到的股票关系     | 收益率高度相关的股票对           |
| **数据来源** | 新闻标题（LLM 抽取）        | 收盘价 → 对数收益率               |
| **时间范围** | Date < 2020-12-31，时间衰减 | 最近 30 天，且 Date < 2020-12-31 |
| **关键参数** | α=0.995 时间衰减（半衰期≈138 天，依论文 2.1+3.3） | 窗口=30 天，阈值 |ρ|>0.6        |
| **稀疏性** | 很稀疏（显式关系少）         | 较密（隐式相关多）               |
| **作用**   | 提供“可解释”的新闻关系层     | 补连通性、提供量价联动层          |

最终**混合图** = 归一化后的（语义图 + λ·统计图），λ=1.0，所以 19 条语义边 + 2760 条统计边一起参与训练时的图结构。
