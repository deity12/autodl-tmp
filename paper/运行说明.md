# 运行说明：一步一步跑通 QL-MATCC-GNN

在**项目根目录** `e:\paper` 下打开终端，按下面顺序执行。每步完成后再做下一步。

---

## 运行前准备

1. **原始数据**放到约定目录：
   - 股价：`data/raw/FNSPID/full_history/` 下每个股票一个 CSV（如 `AAPL.csv`）
   - 新闻：`data/raw/FNSPID/nasdaq_exteral_data.csv`（etl 会按需分块读）
2. **安装依赖**：
   ```bash
   pip install torch pandas numpy scikit-learn tqdm matplotlib pennylane openai
   ```
   （若用 `download_market_index.py` 下载大盘，还需：`pip install akshare`）

---

## 第一步：下载大盘指数（若还没有）

`align.py` 需要 `data/raw/FNSPID/SP500_Index.csv`。若该文件已存在可跳过。

```bash
python dataProcessed/download_market_index.py
```

若失败，可手动下载 S&P 500 日频数据，按 `Date, Market_Close, Market_Vol` 三列整理成 CSV 放到上述路径。

---

## 第二步：ETL，生成股价和新闻

合并股价、从大新闻文件中提取指定股票与时间段的新闻，得到：

- `data/processed/Stock_Prices.csv`
- `data/processed/Stock_News.csv`

```bash
python dataProcessed/etl.py
```

---

## 第三步：对齐数据，生成模型输入

把股价、大盘、新闻按日期和股票对齐，并计算波动率等，得到：

- `data/processed/Final_Model_Data.csv`

```bash
python dataProcessed/align.py
```

---

## 第四步：构建图谱（LLM 动态图谱）

从新闻中建公司关系图，得到邻接矩阵，供 GNN 使用：

- `data/processed/Graph_Adjacency.npy`

```bash
python dataProcessed/build_graph.py
```

未配置 LLM API 时，会用「新闻中提及某股票代码即建边」的规则建图，能直接跑通。

---

## 第五步：训练 QL-MATCC-GNN

用 `Final_Model_Data.csv` 和 `Graph_Adjacency.npy` 训练模型。  
`dataset.py` 会在训练时被 `train_gnn.py` 自动调用，无需单独运行。

```bash
python model/train_gnn.py
```

训练完成后会得到：

- `model/best_model_gnn.pth`：最佳模型参数  
- `model/training_curve_gnn.png`：训练/验证损失曲线  

---

## 流程总览

```
download_market_index.py  →  SP500_Index.csv（若无则先做）
         ↓
     etl.py          →  Stock_Prices.csv, Stock_News.csv
         ↓
    align.py         →  Final_Model_Data.csv
         ↓
  build_graph.py     →  Graph_Adjacency.npy
         ↓
  train_gnn.py       →  best_model_gnn.pth, training_curve_gnn.png
```

---

## 当前保留的文件

| 目录 | 文件 | 作用 |
|------|------|------|
| dataProcessed | etl.py | 合并股价、提取新闻 |
| dataProcessed | download_market_index.py | 下载 S&P 500 大盘 |
| dataProcessed | align.py | 对齐价格+大盘+新闻，算波动率 |
| dataProcessed | build_graph.py | 从新闻建图，输出邻接矩阵 |
| dataProcessed | dataset.py | 数据集类，供 train_gnn 调用 |
| model | model.py | QL-MATCC、Quantum-RWKV 等底层模块 |
| model | model_gnn.py | QL-MATCC-GNN（时序 + GAT 融合） |
| model | train_gnn.py | 训练入口 |

其它训练、评估、古典模型等脚本已删除，只保留上述一条完整链路。
