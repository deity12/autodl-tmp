#!/bin/bash
# =====================================================================
# QL-MATCC-GNN å®Œæ•´è®­ç»ƒæµç¨‹ - 48GBæ˜¾å­˜ä¼˜åŒ–ç‰ˆ
# =====================================================================
# æœåŠ¡å™¨é…ç½®:
#   - GPU: vGPU-48GB-350W
#   - CPU: 12 vCPU Intel Xeon
#   - RAM: 90GB
#
# é¢„è®¡æ€»è€—æ—¶: 14-16å°æ—¶
# =====================================================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢
cd /root/autodl-tmp/paper

# =====================================================================
# æœåŠ¡å™¨é…ç½®æ£€æµ‹
# =====================================================================
echo "====================================================================="
echo "æœåŠ¡å™¨é…ç½®æ£€æµ‹"
echo "====================================================================="
echo "GPUä¿¡æ¯:"
nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv,noheader

echo ""
echo "å†…å­˜ä¿¡æ¯:"
free -h | grep Mem

echo ""
echo "CPUä¿¡æ¯:"
echo "CPUæ ¸å¿ƒæ•°: $(nproc)"

echo ""
echo "ç£ç›˜ç©ºé—´:"
df -h | grep -E '(Filesystem|/root|data)'

echo ""
echo "Pythonç¯å¢ƒ:"
python --version
echo "PyTorchç‰ˆæœ¬: $(python -c 'import torch; print(torch.__version__)')"
echo "CUDAå¯ç”¨: $(python -c 'import torch; print(torch.cuda.is_available())')"

echo ""
echo "====================================================================="
read -p "é…ç½®ç¡®è®¤æ— è¯¯ï¼ŸæŒ‰Enterç»§ç»­ï¼ŒCtrl+Cå–æ¶ˆ..." 

# =====================================================================
# Step 1: æ•°æ®å¤„ç†
# =====================================================================
echo ""
echo "====================================================================="
echo "Step 1/4: æ•°æ®å¤„ç†"
echo "====================================================================="

if [ ! -f "data/processed/Stock_Prices.csv" ]; then
    echo ">>> [1.1] ETLå¤„ç† (é¢„è®¡5-10åˆ†é’Ÿ)..."
    python -m dataProcessed.etl
else
    echo "âœ“ Stock_Prices.csv å·²å­˜åœ¨ï¼Œè·³è¿‡ETL"
fi

if [ ! -f "data/processed/Final_Model_Data.csv" ]; then
    echo ">>> [1.2] æ•°æ®å¯¹é½ (é¢„è®¡2-5åˆ†é’Ÿ)..."
    python -m dataProcessed.align
else
    echo "âœ“ Final_Model_Data.csv å·²å­˜åœ¨ï¼Œè·³è¿‡å¯¹é½"
fi

echo ">>> [1.3] LLMå›¾è°±æ„å»º (é¢„è®¡60-90åˆ†é’Ÿ)..."
echo "âš ï¸  è¿™å°†ä½¿ç”¨Qwen2.5-14Bæ¨¡å‹æå–è¯­ä¹‰å…³ç³»"
echo "âš ï¸  é¦–æ¬¡è¿è¡Œéœ€è¦ä¸‹è½½æ¨¡å‹ï¼ˆçº¦26GBï¼‰"
read -p "ç¡®è®¤å¯åŠ¨LLMæ¨¡å¼ï¼ŸæŒ‰Enterç»§ç»­ï¼ŒCtrl+Cå–æ¶ˆ..." 

python -m dataProcessed.build_graph --use_llm

echo "âœ“ æ•°æ®å¤„ç†å®Œæˆï¼"

# =====================================================================
# Step 2: è®­ç»ƒå®Œæ•´æ¨¡å‹
# =====================================================================
echo ""
echo "====================================================================="
echo "Step 2/4: è®­ç»ƒå®Œæ•´æ¨¡å‹ (é¢„è®¡150åˆ†é’Ÿ / 30 epochs)"
echo "====================================================================="
echo "é…ç½®: n_embd=384, n_layers=4, batch_size=1024, epochs=30"
echo ""

python -m training.train_full

echo "âœ“ å®Œæ•´æ¨¡å‹è®­ç»ƒå®Œæˆï¼"

# =====================================================================
# Step 3: æ¶ˆèå®éªŒ
# =====================================================================
echo ""
echo "====================================================================="
echo "Step 3/4: æ¶ˆèå®éªŒ (é¢„è®¡750åˆ†é’Ÿ / 5ä¸ªå®éªŒ)"
echo "====================================================================="
echo "å°†è¿è¡Œ5ç»„æ¶ˆèå®éªŒ:"
echo "  1. Full Model (åŸºå‡†)"
echo "  2. w/o Quantum"
echo "  3. w/o Graph"
echo "  4. w/o MATCC"
echo "  5. w/o Market Guidance"
echo ""
read -p "ç¡®è®¤è¿è¡Œæ¶ˆèå®éªŒï¼ŸæŒ‰Enterç»§ç»­ï¼Œè¾“å…¥nè·³è¿‡..." skip_ablation

if [ "$skip_ablation" != "n" ]; then
    python -m training.train_ablation
    echo "âœ“ æ¶ˆèå®éªŒå®Œæˆï¼"
else
    echo "âŠ˜ è·³è¿‡æ¶ˆèå®éªŒ"
fi

# =====================================================================
# Step 4: è¯„ä¼°
# =====================================================================
echo ""
echo "====================================================================="
echo "Step 4/4: æ¨¡å‹è¯„ä¼°"
echo "====================================================================="

python -m evaluation.evaluate_all
python -m evaluation.evaluate_by_group

echo "âœ“ è¯„ä¼°å®Œæˆï¼"

# =====================================================================
# è®­ç»ƒå®Œæˆæ€»ç»“
# =====================================================================
echo ""
echo "====================================================================="
echo "ğŸ‰ å…¨éƒ¨æµç¨‹å®Œæˆï¼"
echo "====================================================================="
echo ""
echo "ğŸ“Š ç»“æœæ–‡ä»¶ä½ç½®:"
echo "  - æ¨¡å‹æƒé‡: outputs/checkpoints/"
echo "  - è®­ç»ƒæ—¥å¿—: outputs/logs/"
echo "  - å¯è§†åŒ–å›¾è¡¨: outputs/figures/"
echo "  - è¯„ä¼°ç»“æœ: outputs/results/"
echo ""
echo "ğŸ“ˆ æŸ¥çœ‹è¯„ä¼°ç»“æœ:"
echo "  cat outputs/results/evaluation_overall.csv"
echo "  cat outputs/results/ablation_results_summary.csv"
echo ""
echo "ğŸ–¼ï¸  æŸ¥çœ‹è®­ç»ƒæ›²çº¿:"
echo "  ls outputs/figures/"
echo ""
echo "====================================================================="
